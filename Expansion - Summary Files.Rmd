---
title: "EOY 2019 Expansion"
output: html_notebook
---

```{r}
library(tidyverse)
library(purrr)
library(roxygen2)
library(data.table)
library(rlang)
source("N:\\CommDev\\Research\\Public\\Overview of Census and ACS Data\\sumRange.R")
```

# Function to name files

```{r}
#' File naming
#'
#' Creates names for files saved in memory
#'
#' @param name_vector character vector of file names, usually produced by list.files()
#'
#' @return Character vector of length 1 by which to name the file
#' 
#' @examples
#' list2env(purrr::map(set_names(file_vector_from_list.files, make_names(file_vector_from_list.files), 
#'                     read_csv), 
#'          envir = .GlobalEnv))
#'
#' @export
make_names <- function(name_vector) {
  
  name_vector_df <- as.data.frame(name_vector)
  
  new_names <- name_vector_df %>%
    rename(df_name = 1) %>%
    separate(df_name, into = c("df_name", "drop"), sep = 7) %>%
    dplyr::select(-drop)
  
  new_names_list <- as.list(new_names)
  
  return(new_names_list$df_name)
}

```

# Read in files

```{r}
acs_files <- list.files(path = "N:\\CommDev\\Research\\Research\\Census Data\\ACS\\5_Excel_Data\\",
                    pattern = "metros.csv$")

setwd("N:\\CommDev\\Research\\Research\\Census Data\\ACS\\5_Excel_Data\\")

list2env(purrr::map(set_names(acs_files, make_names(acs_files)), read_csv), envir = .GlobalEnv)

```

```{r}
#' Sum variables within a range and by a certain interval
#'
#' Creates a sum expression to be used with the "mutate" function
#'
#' @param table Census table ID, including "e" or zeros
#' @param start first row in range to be summed
#' @param end last row in range to be summed
#' @param int intervals at which the rows occur
#' 
#' @return expression that can be used in tandem with "mutate" to create new variable
#' 
#' @example
#' mutate(df, Employment_by_disability = !! census_sum("B18130e", 5, 40, 7))
#'
#' @export 

census_sum <- function(table, start, end, int) {
  
 rlang::parse_expr(paste(rep(table), seq(from = start, to = end, by = int), sep = "", collapse = " + "))
  
}

# Non-rlang equivalent, then has to be wrapped in "eval()" function
# parse(text =

census_sum_select <- function(table, indices) {
  
  rlang::parse_expr(paste(rep(table),  indices, sep = "", collapse = " + "))
  
}

paste(rep("B17001e"), seq(from = 54, to = 107, by = c(2, 5), sep = "", collapse = " + "))
```

# Employment status and poverty status by disability (2005-2018)

Use odds ratio to calculate disparities (see Matt Schroeder's helpful explanation below).

![Odds-ratio explanation](Odds-ratio for disparities.png)

Calculate odds of those with 1+ disabilities being employed relative to odds of those with no disabilities being employed.  Where odds of 1+ disabilities persons being employed are lower relative to odds of those with no disabilities being employed, disparity is wider. For example, if odds of 1+ disabilities person being employed (relative to a no disabilities person) in Area 1 is 0.11 and odds are 0.56 in Area 2, disparity between the two groups is wider in Area 1.


Calculate odds of those with 1+ disabilities being at/above poverty relative to odds of those with no disabilities being at/above poverty.  Where odds of 1+ disabilities persons being at/above poverty are lower relative to odds of those with no disabilities being at/above poverty, disparity is wider. For example, if odds of 1+ disabilities person being at/above poverty (relative to a no disabilities person) in Area 1 is 0.11 and odds are 0.56 in Area 2, disparity between the two groups is wider in Area 1.

```{r}
#' Employment status and poverty status by disability for 25 largest CBSAs in US from 2005-2018
#'
#' Using separate 1-year ACS summary files, calculates employment and poverty status by disability
#'
#' @param df dataframe named in the format "acsXXXX" where XXXX is the year and containing 1-year ACS summary file data for a year 2005 or later; in this case from local, custom-processed files in N:/CommDev/Research/Research/Census
#'
#' @return dataframe appended with "_disability_vars" containing employment status and poverty status by disability for 26 US metros for 2005-2018
#' 
#' @examples
#' disability_vars(acs2009)
#'
#' @export 

disability_vars <- function(df) {
  
  df_name <- deparse(substitute(df))
  
  df_year <- as.numeric(substr(df_name, 4, 7))
  
  if(df_year < 2005) {
    
    print("Not a valid year for the function.  Function current as of January 2020.")
    
  } else if (df_year >= 2009) {
    
  # Years 2009 and later use different table codes than 2007-2008 or 2005-2006
    df_pared <- df %>%
      dplyr::select(CBSA, starts_with("B18120"), starts_with("B18130")) %>%
      transmute(CBSA = CBSA,
                Employed_disability = B18120e4/(B18120e4 + B18120e13 + B18120e22), # Denom = total population with disability
                Employed_no_disability = B18120e11/(B18120e11 + B18120e20 + B18120e29), # Denom = total population with no disability
                Above_poverty_disability = !! census_sum("B18130e", 5, 40, 7),
                Above_poverty_no_disability = !! census_sum("B18130e", 8, 43, 7),
                Prop_above_poverty_disability = Above_poverty_disability/(Above_poverty_disability + !! census_sum("B18130e", 4, 39, 7)),
                Prop_above_poverty_no_disability = Above_poverty_no_disability/(Above_poverty_no_disability + !! census_sum("B18130e", 7, 42, 7))) %>%
      dplyr::select(-starts_with("Above"))
    
    invisible(df_pared)
    
  } else if (df_year <= 2007 & df_year >= 2005) {
    
    # Years 2005 and 2006
    df_pared <- df %>%
      dplyr::select(CBSA, starts_with("B18020e"), starts_with("B18030")) %>%
      transmute(CBSA = CBSA,
                Employed_disability = (B18020e5 + B18020e8 + B18020e12 + B18020e15)/B18020e2, # Num = males and females of two different age groups that have 1+ disabilities and are employed
                Employed_no_disability = (B18020e20 + B18020e23 + B18020e27 + B18020e30)/B18020e17,
                Prop_above_poverty_disability = (!! census_sum("B18030e", 6, 15, 3) + B18030e19 + B18030e22 + B18030e25 + B18030e28)/B18030e2,
                Prop_above_poverty_no_disability = (!! census_sum("B18030e", 33, 42, 3) + !! census_sum("B18030e", 46, 55, 3))/B18030e29)
    
    invisible(df_pared)
    
  }
  
  else if (df_year == 2008) {
    
     
    df_pared <- df %>%
      dplyr::select(CBSA, starts_with("B18120"), starts_with("B18130")) %>%
      transmute(CBSA = CBSA,
                Employed_disability = (B18120e4 + B18120e11)/(B18120e3 + B18120e10),
                Employed_no_disability = (B18120e7 + B18120e14)/(B18120e6 + B18120e13),
                Above_poverty_disability = !! census_sum("B18130e", 5, 40, 7),
                Above_poverty_no_disability = !! census_sum("B18130e", 8, 43, 7),
                Prop_above_poverty_disability = Above_poverty_disability/(Above_poverty_disability + !! census_sum("B18130e", 4, 39, 7)),
                Prop_above_poverty_no_disability = Above_poverty_no_disability/(Above_poverty_no_disability + !! census_sum("B18130e", 7, 42, 7))) %>%
      dplyr::select(-starts_with("Above"))
    
    invisible(df_pared)
    
  }
  
  else {
    
    print("Missing data for input.")
  }
  
  # Same calculation process for all years
  
  # Employment status by disability
      df_employment <- df_pared %>%            
      mutate(Odds_employ_no_disability = Employed_no_disability/(1-Employed_no_disability), # Create odds variable (See "OddsRatioDemo.xlsx for more info")
             Odds_employ_disability = Employed_disability/(1-Employed_disability), # Create odds variable
             Employ_disparity = Odds_employ_disability/Odds_employ_no_disability) %>% # Ratio of odds of being employed (Disability:No disability)
      dplyr::select(-starts_with("Odds"), -starts_with("Prop")) %>%
      arrange(desc(Employed_disability)) %>%
      mutate(Rank_employed_disability = dplyr::row_number()) %>%
      arrange(desc(Employed_no_disability)) %>%
      mutate(Rank_employed_no_disability = dplyr::row_number()) %>%
      arrange(Employ_disparity) %>% # Lower odds = wider disparity
      mutate(Rank_disparity = dplyr::row_number()) %>%
      dplyr::select(-Employ_disparity) %>%
      unite(Employed_disability, Rank_employed_disability, Employed_disability) %>%
      unite(Employed_no_disability, Rank_employed_no_disability, Employed_no_disability) %>%
      gather(Employed_disability, Employed_no_disability, key = "Topic_area_equity_group", value = "Rank_measure") %>%
      separate(Topic_area_equity_group, into = c("TOPIC_AREA", "EQUITY_GROUP"), sep = 8)
  

  # Poverty status by disability 
      df_poverty <- df_pared %>%
        mutate(Odds_no_poverty_no_disability = Prop_above_poverty_no_disability/(1-Prop_above_poverty_no_disability), 
               Odds_no_poverty_disability = Prop_above_poverty_disability/(1-Prop_above_poverty_disability), # Create odds variable
               Poverty_disparity = Odds_no_poverty_disability/Odds_no_poverty_no_disability) %>%
        dplyr::select(-starts_with("Odds"), -starts_with("Employed")) %>%
        arrange(desc(Prop_above_poverty_disability)) %>% # Higher rates of no poverty amongst those with disability = better
        mutate(Rank_no_poverty_disability = dplyr::row_number()) %>%
        arrange(desc(Prop_above_poverty_no_disability)) %>% # Higher rates of no poverty amongst those with no disabilities = better
        mutate(Rank_no_poverty_no_disability = dplyr::row_number()) %>%
        arrange(Poverty_disparity) %>% # Lower odds of no poverty for disability relative to no disability = wider disparity
        mutate(Rank_disparity = dplyr::row_number()) %>%
        dplyr::select(-Poverty_disparity) %>%
        unite(Poverty_status_disability, Rank_no_poverty_disability, Prop_above_poverty_disability) %>%
        unite(Poverty_status_no_disability, Rank_no_poverty_no_disability, Prop_above_poverty_no_disability) %>%
        gather(Poverty_status_disability, Poverty_status_no_disability, key = "Topic_area_equity_group", value = "Rank_measure") %>%
        separate(Topic_area_equity_group, into = c("TOPIC_AREA", "EQUITY_GROUP"), sep = 14)
  
  
  disability <- rbind(df_employment, df_poverty)
  
  disability_tidy <- disability %>%
    separate(Rank_measure, into = c("Rank of measure", "Measure"), sep = "_") %>%
    gather(`Rank of measure`, Measure, Rank_disparity, key = "MEASURE", value = "VALUE") %>%
    mutate(EQUITY_GROUP = recode(EQUITY_GROUP, `_disability` = "One or more disabilities", `_no_disability` = "No disability"),
           MEASURE = recode(MEASURE, `Rank_disparity` = "Rank of disparity"),
           EQUITY_CHARACTERISTIC = "Disability",
           TOPIC_AREA = ifelse(TOPIC_AREA == "Poverty_status", "At/above poverty:equity group population ratio", "Employment:equity group population ratio")) %>%
    mutate(YEAR = str_replace(df_name, pattern = "acs", replacement = "")) %>%
    mutate(Rank_reference = ifelse(EQUITY_GROUP == "No disability" & MEASURE == "Rank of disparity", 1, 0)) %>%
    filter(Rank_reference != 1) %>% # Remove lines that refer to reference group disparity
    dplyr::select(-Rank_reference)
    
    assign(paste(df_name, "disability_vars", sep = "_"), disability_tidy, envir = .GlobalEnv)
}

# employment_by_disability(acs2009)
# 
# df_list <- list(acs2009,
#                 acs2010,
#                 acs2011,
#                 acs2012,
#                 acs2013,
#                 acs2014,
#                 acs2015,
#                 acs2016,
#                 acs2017,
#                 acs2018)
# 
# e_by_d <- purrr::map(df_list, employment_by_disability)
# 
# names(e_by_d) <- 2009:2018
# 
# list2env(e_by_d ,.GlobalEnv)

disability_vars(acs2005)
disability_vars(acs2006)
disability_vars(acs2007)
disability_vars(acs2008)
disability_vars(acs2009)
disability_vars(acs2010)
disability_vars(acs2011)
disability_vars(acs2012)
disability_vars(acs2013)
disability_vars(acs2014)
disability_vars(acs2015)
disability_vars(acs2016)
disability_vars(acs2017)
disability_vars(acs2018)

disability_df <- rbind(acs2005_disability_vars,
                       acs2006_disability_vars,
                       acs2008_disability_vars,
                       acs2009_disability_vars,
                       acs2010_disability_vars,
                       acs2011_disability_vars,
                       acs2012_disability_vars,
                       acs2013_disability_vars,
                       acs2014_disability_vars,
                       acs2015_disability_vars,
                       acs2016_disability_vars,
                       acs2017_disability_vars,
                       acs2018_disability_vars)

#write_csv(disability_df, "")
```

```{r}
#' Employment status and poverty status by disability for 25 largest CBSAs in US from 2005-2018
#'
#' Using separate 1-year ACS summary files, calculates employment and poverty status by disability
#'
#' @param df dataframe named in the format "acsXXXX" where XXXX is the year and containing 1-year ACS summary file data for a year 2005 or later; in this case from local, custom-processed files in N:/CommDev/Research/Research/Census
#'
#' @return dataframe appended with "_disability_vars" containing employment status and poverty status by disability for 26 US metros for 2005-2018
#' 
#' @examples
#' disability_vars(acs2009)
#'
#' @export 

disability_vars <- function(df) {
  
  df_name <- deparse(substitute(df))
  
  df_year <- as.numeric(substr(df_name, 4, 7))
  
  if(df_year < 2005) {
    
    print("Not a valid year for the function.  Function current as of January 2020.")
    
  } else if (df_year >= 2009) {
    
    # Years 2009 and later use different table codes than 2007-2008 or 2005-2006
    df_pared <- acs2009 %>%
      dplyr::select(CBSA, starts_with("B18120"), starts_with("B18130")) %>%
      transmute(CBSA = CBSA,
                Employed_disability = B18120e4/(B18120e4 + B18120e13 + B18120e22), # Denom = total population with disability
                Employed_no_disability = B18120e11/(B18120e11 + B18120e20 + B18120e29), # Denom = total population with no disability
                Above_poverty_disability = !! census_sum("B18130e", 5, 40, 7),
                Above_poverty_no_disability = !! census_sum("B18130e", 8, 43, 7),
                Prop_above_poverty_disability = Above_poverty_disability/(Above_poverty_disability + !! census_sum("B18130e", 4, 39, 7)),
                Prop_above_poverty_no_disability = Above_poverty_no_disability/(Above_poverty_no_disability + !! census_sum("B18130e", 7, 42, 7))) %>%
      dplyr::select(-starts_with("Above"))
    
    invisible(df_pared)
    
  } else if (df_year <= 2007 & df_year >= 2005) {
    
    # Years 2005 and 2006
    df_pared <- df %>%
      dplyr::select(CBSA, starts_with("B18020e"), starts_with("B18030")) %>%
      transmute(CBSA = CBSA,
                Employed_disability = (B18020e5 + B18020e8 + B18020e12 + B18020e15)/B18020e2, # Num = males and females of two different age groups that have 1+ disabilities and are employed
                Employed_no_disability = (B18020e20 + B18020e23 + B18020e27 + B18020e30)/B18020e17,
                Prop_above_poverty_disability = (!! census_sum("B18030e", 6, 15, 3) + B18030e19 + B18030e22 + B18030e25 + B18030e28)/B18030e2,
                Prop_above_poverty_no_disability = (!! census_sum("B18030e", 33, 42, 3) + !! census_sum("B18030e", 46, 55, 3))/B18030e29)
    
    invisible(df_pared)
    
  }
  
  else if (df_year == 2008) {
    
    
    df_pared <- df %>%
      dplyr::select(CBSA, starts_with("B18120"), starts_with("B18130")) %>%
      transmute(CBSA = CBSA,
                Employed_disability = (B18120e4 + B18120e11)/(B18120e3 + B18120e10),
                Employed_no_disability = (B18120e7 + B18120e14)/(B18120e6 + B18120e13),
                Above_poverty_disability = !! census_sum("B18130e", 5, 40, 7),
                Above_poverty_no_disability = !! census_sum("B18130e", 8, 43, 7),
                Prop_above_poverty_disability = Above_poverty_disability/(Above_poverty_disability + !! census_sum("B18130e", 4, 39, 7)),
                Prop_above_poverty_no_disability = Above_poverty_no_disability/(Above_poverty_no_disability + !! census_sum("B18130e", 7, 42, 7))) %>%
      dplyr::select(-starts_with("Above"))
    
    invisible(df_pared)
    
  }
  
  else {
    
    print("Missing data for input.")
  }
  
  # Same calculation process for all years
  
  # Employment and poverty status by disability
  df_disparity <- df_pared %>%            
    transmute(CBSA = CBSA,
              Odds_employ_no_disability = Employed_no_disability/(1-Employed_no_disability), # Create odds variable (See "OddsRatioDemo.xlsx for more info")
              Odds_employ_disability = Employed_disability/(1-Employed_disability), # Create odds variable
              Employ_disparity = Odds_employ_disability/Odds_employ_no_disability,
              Odds_no_poverty_no_disability = Prop_above_poverty_no_disability/(1-Prop_above_poverty_no_disability), 
              Odds_no_poverty_disability = Prop_above_poverty_disability/(1-Prop_above_poverty_disability), # Create odds variable
              Poverty_disparity = Odds_no_poverty_disability/Odds_no_poverty_no_disability) %>% # Ratio of odds of being employed (Disability:No disability)
    dplyr::select(-starts_with("Odds")) %>%
    arrange(CBSA) %>% # Lower odds of no poverty for disability relative to no disability = wider disparity
    mutate(Index = dplyr::row_number())
  
  df_employ_pov <- df_pared %>%
    arrange(desc(CBSA)) %>%
    mutate(Index = dplyr::row_number())
  
  
  # Get rank of each column (descending order, largest # = highest rank)
  ep_ranks <- as.data.frame(purrr::map(-df_employ_pov, rank))
  colnames(ep_ranks) <- paste(colnames(df_employ_pov), "rank", sep = "_")
  
  ep_full <- full_join(df_employ_pov, ep_ranks, by = c("Index" = "CBSA_rank"))
  
  # Get rank of disparities (ascending/default order, smallest # = worst disparity and highest rank)
  disparity_ranks <- as.data.frame(purrr::map(df_disparity, rank))
  colnames(disparity_ranks) <- paste(colnames(df_disparity), "rank", sep = "_")
  
  disparity_full <- full_join(df_disparity, disparity_ranks, by = c("Index" = "CBSA_rank"))
  
  ep_disparity <- full_join(ep_full, disparity_full, by = "CBSA")
  
  # Re-structure/tidy df        
  disability <- ep_disparity %>%
    dplyr::select(-starts_with("Index"), -Employ_disparity, -Poverty_disparity) %>%
    gather(starts_with("Employ"), starts_with("P"), key = "Topic_group", value = "VALUE") %>%
    mutate(Topic_employ = str_detect(Topic_group, "Employ"),
           Group_no_disability = str_detect(Topic_group, "no"),
           Rank = str_detect(Topic_group, "rank"),
           Disparity = str_detect(Topic_group, "disparity"),
           TOPIC_AREA = ifelse(Topic_employ == "TRUE", "Employment:equity group population ratio", "At/above poverty:equity group population ratio"),
           EQUITY_GROUP = ifelse(Group_no_disability == "TRUE", "No disability", "One or more disabilities"),
           MEASURE = ifelse(Rank == "TRUE" & Disparity == "TRUE", "Rank of disparity",
                            ifelse(Rank == "TRUE" & Disparity == "FALSE", "Rank of measure", "Measure")),
           YEAR = str_replace(df_name, pattern = "acs", replacement = "")) %>%
    dplyr::select(-Topic_employ, -Group_no_disability, -Rank, -Disparity, -Topic_group)
  
  assign(paste(df_name, "disability_vars", sep = "_"), disability, envir = .GlobalEnv)
}

# employment_by_disability(acs2009)
# 
# df_list <- list(acs2009,
#                 acs2010,
#                 acs2011,
#                 acs2012,
#                 acs2013,
#                 acs2014,
#                 acs2015,
#                 acs2016,
#                 acs2017,
#                 acs2018)
# 
# e_by_d <- purrr::map(df_list, employment_by_disability)
# 
# names(e_by_d) <- 2009:2018
# 
# list2env(e_by_d ,.GlobalEnv)

disability_vars(acs2005)
disability_vars(acs2006)
disability_vars(acs2007)
disability_vars(acs2008)
disability_vars(acs2009)
disability_vars(acs2010)
disability_vars(acs2011)
disability_vars(acs2012)
disability_vars(acs2013)
disability_vars(acs2014)
disability_vars(acs2015)
disability_vars(acs2016)
disability_vars(acs2017)
disability_vars(acs2018)

disability_df <- rbind(acs2005_disability_vars,
                       acs2006_disability_vars,
                       acs2008_disability_vars,
                       acs2009_disability_vars,
                       acs2010_disability_vars,
                       acs2011_disability_vars,
                       acs2012_disability_vars,
                       acs2013_disability_vars,
                       acs2014_disability_vars,
                       acs2015_disability_vars,
                       acs2016_disability_vars,
                       acs2017_disability_vars,
                       acs2018_disability_vars)
```

```{r}
# try_summing <- function(df){
# 
# 
#   df_new3 <<- df %>%
#     dplyr::select(starts_with("B18130")) %>%
#     transmute(sum_b18020 = eval(parse(text = paste(rep("B18130e", 5), seq(from = 5, to = 40, by = 7), sep = "", collapse = " + "))))
# 
# }
# 
# try_summing(acs2009)
# 
# 
# try_sum2 <- function(df) {
#   df_new2 <<- df %>%
#     dplyr::select(starts_with("B18130")) %>%
#     transmute(sum_b18020 = census_sum("B18130"), 5, 40, 7)
# }
# 
# parse(text = paste(rep("B18130e", 5), seq(from = 5, to = 40, by = 7), sep = "", collapse = " + "))
```

# Employment by age (B23001) (2005-2018)

Disparity and rank of disparity aren't calculated.  No "typical" or "accepted" reference group for age exists.

```{r}

employment_by_age <- function(df) {
  
  df_name <- deparse(substitute(df))
  
  df_year <- as.numeric(substr(df_name, 4, 7))
  
  df_tidy <- df %>%
    dplyr::select(CBSA, starts_with("B23001")) %>%
    transmute(CBSA = CBSA,
              Employed_16_19 = (!! census_sum_select("B23001e", c(5, 7, 91, 93)))/(B23001e3 + B23001e89),
              Employed_20_34 = (!! census_sum_select("B23001e", c(12, 14, 19, 21, 26, 28, 33, 35, 98, 100, 105, 107, 112, 114, 119, 121)))/(!! census_sum("B23001e", 10, 31, 7) + !! census_sum("B23001e", 96, 117, 7)),
              Employed_35_64 = (!! census_sum_select("B23001e", c(40, 42, 47, 49, 54, 56, 61, 63, 68, 70, 126, 128, 133, 135, 140, 142, 147, 149, 154, 156)))/(!! census_sum("B23001e", 38, 66, 7) +  !! census_sum("B23001e", 124, 152, 7)),
              Employed_65_over = (!! census_sum_select("B23001e", c(75, 80, 85, 161, 166, 171)))/(!! census_sum_select("B23001e", c(73, 78, 83, 159, 164, 169)))) %>%
    arrange(desc(CBSA)) %>%
    mutate(Index = row_number())
  
  # Get rank of each column (descending order, largest = highest rank)
  employment_ranks <- as.data.frame(purrr::map(-df_tidy, rank))
  colnames(employment_ranks) <- paste(colnames(df_tidy), "rank", sep = "_")
  
  employment_full <- full_join(df_tidy, employment_ranks, by = c("Index" = "CBSA_rank"))
  
  employment <- employment_full %>%
    dplyr::select(-starts_with("Index")) %>%
    unite(`16-19`, Employed_16_19, Employed_16_19_rank) %>%
    unite(`20-34`, Employed_20_34, Employed_20_34_rank) %>%
    unite(`35-64`, Employed_35_64, Employed_35_64_rank) %>%
    unite(`65+`, Employed_65_over, Employed_65_over_rank) %>%
    gather(`16-19`:`65+`, key = "EQUITY_GROUP", value = "Measure_rank") %>%
    mutate(EQUITY_CHARACTERISTIC = "Age",
           TOPIC_AREA = "Employment:equity group population ratio") %>%
    separate(Measure_rank, into = c("Measure", "Rank of measure"), sep = "_") %>%
    gather(Measure, `Rank of measure`, key = "MEASURE", value = "VALUE") %>%
    mutate(YEAR = str_replace(df_name, pattern = "acs", replacement = ""))
  
  assign(paste(df_name, "e_by_age", sep = "_"), employment, envir = .GlobalEnv)
  
}

employment_by_age(acs2005)
employment_by_age(acs2006)
employment_by_age(acs2007)
employment_by_age(acs2008)
employment_by_age(acs2009)
employment_by_age(acs2010)
employment_by_age(acs2011)
employment_by_age(acs2012)
employment_by_age(acs2013)
employment_by_age(acs2014)
employment_by_age(acs2015)
employment_by_age(acs2016)
employment_by_age(acs2017)
employment_by_age(acs2018)

e_by_age_df <- rbind(acs2005_e_by_age,
                     acs2006_e_by_age,
                     acs2007_e_by_age,
                     acs2008_e_by_age,
                     acs2009_e_by_age,
                     acs2010_e_by_age,
                     acs2011_e_by_age,
                     acs2012_e_by_age,
                     acs2013_e_by_age,
                     acs2014_e_by_age,
                     acs2015_e_by_age,
                     acs2016_e_by_age,
                     acs2017_e_by_age,
                     acs2018_e_by_age)

```

# Poverty by age (B17001) (2005-2018)

Disparity and rank of disparity aren't calculated.  No "typical" or "accepted" reference group for age exists.

```{r}

poverty_by_age <- function(df) {
  
  df_name <- deparse(substitute(df))
  
  df_year <- as.numeric(substr(df_name, 4, 7))
  
  df_tidy <- df %>%
    dplyr::select(CBSA, starts_with("B17001")) %>%
    transmute(CBSA = CBSA,
              Above_poverty_18_34 = !! census_sum_select("B17001e", c(39, 40, 53, 54)),
              Above_poverty_35_64 = !! census_sum_select("B17001e", c(41, 42, 43, 55, 56, 57)),
              Above_poverty_65 = !! census_sum_select("B17001e", c(44, 45, 58, 59)),
              Prop_18_34 = Above_poverty_18_34/(Above_poverty_18_34 + !! census_sum_select("B17001e", c(10, 11, 24, 25))),
              Prop_35_64 = Above_poverty_35_64/(Above_poverty_35_64 + !! census_sum_select("B17001e", c(12, 13, 14, 26, 27, 28))),
              Prop_65 = Above_poverty_65/(Above_poverty_65 + !! census_sum_select("B17001e", c(15, 16, 29, 30)))) %>%
    dplyr::select(-starts_with("Above")) %>%
    arrange(desc(CBSA)) %>%
    mutate(Index = row_number())
    
  # Get rank of each column (descending order, largest = highest rank)
  poverty_ranks <- as.data.frame(purrr::map(-df_tidy, rank))
  colnames(poverty_ranks) <- paste(colnames(df_tidy), "rank", sep = "_")
  
  poverty_full <- full_join(df_tidy, poverty_ranks, by = c("Index" = "CBSA_rank"))    
  
  poverty <- poverty_full %>%
    dplyr::select(-starts_with("Index")) %>%
    unite(`18-34`, Prop_18_34, Prop_18_34_rank) %>%
    unite(`35-64`, Prop_35_64, Prop_35_64_rank) %>%
    unite(`65+`, Prop_65, Prop_65_rank) %>%
    gather(`18-34`:`65+`, key = "EQUITY_GROUP", value = "Measure_rank") %>%
    mutate(EQUITY_CHARACTERISTIC = "Age",
           TOPIC_AREA = "At/above poverty:equity group population ratio") %>%
    separate(Measure_rank, into = c("Measure", "Rank of measure"), sep = "_") %>%
    gather(Measure, `Rank of measure`, key = "MEASURE", value = "VALUE") %>%
    mutate(YEAR = str_replace(df_name, pattern = "acs", replacement = ""))
  
  assign(paste(df_name, "p_by_age", sep = "_"), poverty, envir = .GlobalEnv)
  
}

poverty_by_age(acs2005)
poverty_by_age(acs2006)
poverty_by_age(acs2007)
poverty_by_age(acs2008)
poverty_by_age(acs2009)
poverty_by_age(acs2010)
poverty_by_age(acs2011)
poverty_by_age(acs2012)
poverty_by_age(acs2013)
poverty_by_age(acs2014)
poverty_by_age(acs2015)
poverty_by_age(acs2016)
poverty_by_age(acs2017)
poverty_by_age(acs2018)

poverty_by_age_df <- rbind(acs2005_p_by_age,
                           acs2006_p_by_age,
                           acs2007_p_by_age,
                           acs2008_p_by_age,
                           acs2009_p_by_age,
                           acs2010_p_by_age,
                           acs2011_p_by_age,
                           acs2012_p_by_age,
                           acs2013_p_by_age,
                           acs2014_p_by_age,
                           acs2015_p_by_age,
                           acs2016_p_by_age,
                           acs2017_p_by_age,
                           acs2018_p_by_age)

```

# Homeownership by age (2005-2018)

Disparity and rank of disparity aren't calculated.  No "typical" or "accepted" reference group for age exists.

```{r}

tenure_by_age <- function(df) {
  
  df_name <- deparse(substitute(df))
  
  df_year <- as.numeric(substr(df_name, 4, 7))
  
  df_tidy <- df %>%
    dplyr::select(CBSA, starts_with("B25007")) %>%
    transmute(CBSA = CBSA,
              Owner_occ_15_24 = B25007e3/(B25007e3 + B25007e13),
              Owner_occ_25_34 = B25007e4/(B25007e4 + B25007e14),
              Owner_occ_35_64 = (!! census_sum("B25007e", 5, 8, 1))/(!! census_sum("B25007e", 5, 8, 1) + !! census_sum("B25007e", 15, 18, 1)),
              Owner_occ_65_over = (B25007e9 + B25007e10 + B25007e11)/(!! census_sum_select("B25007e", c(9, 10, 11, 19, 20, 21)))) %>%
    arrange(desc(CBSA)) %>%
    mutate(Index = row_number())
  
  # Get rank of each column (descending order, largest = highest rank)
  tenure_ranks <- as.data.frame(purrr::map(-df_tidy, rank))
  colnames(tenure_ranks) <- paste(colnames(df_tidy), "rank", sep = "_")
  
  tenure_full <- full_join(df_tidy, tenure_ranks, by = c("Index" = "CBSA_rank"))
  
  tenure <- tenure_full %>%
    dplyr::select(-starts_with("Index")) %>%
    unite(`15-24`, Owner_occ_15_24, Owner_occ_15_24_rank) %>%
    unite(`25-34`, Owner_occ_25_34, Owner_occ_25_34_rank) %>%
    unite(`35-64`, Owner_occ_35_64, Owner_occ_35_64_rank) %>%
    unite(`65+`, Owner_occ_65_over, Owner_occ_65_over_rank) %>%
    gather(`15-24`:`65+`, key = "EQUITY_GROUP", value = "Measure_rank") %>%
    mutate(EQUITY_CHARACTERISTIC = "Age",
           TOPIC_AREA = "Owner-occupied units:equity group population ratio") %>%
    separate(Measure_rank, into = c("Measure", "Rank of measure"), sep = "_") %>%
    gather(Measure, `Rank of measure`, key = "MEASURE", value = "VALUE") %>%
    mutate(YEAR = str_replace(df_name, pattern = "acs", replacement = ""))
  
  assign(paste(df_name, "tenure_by_age", sep = "_"), tenure, envir = .GlobalEnv)
  
}

tenure_by_age(acs2005)
tenure_by_age(acs2006)
tenure_by_age(acs2007)
tenure_by_age(acs2008)
tenure_by_age(acs2009)
tenure_by_age(acs2010)
tenure_by_age(acs2011)
tenure_by_age(acs2012)
tenure_by_age(acs2013)
tenure_by_age(acs2014)
tenure_by_age(acs2015)
tenure_by_age(acs2016)
tenure_by_age(acs2017)
tenure_by_age(acs2018)

tenure_by_age_df <- rbind(acs2005_tenure_by_age,
                          acs2006_tenure_by_age,
                          acs2007_tenure_by_age,
                          acs2008_tenure_by_age,
                          acs2009_tenure_by_age,
                          acs2010_tenure_by_age,
                          acs2011_tenure_by_age,
                          acs2012_tenure_by_age,
                          acs2013_tenure_by_age,
                          acs2014_tenure_by_age,
                          acs2015_tenure_by_age,
                          acs2016_tenure_by_age,
                          acs2017_tenure_by_age,
                          acs2018_tenure_by_age)

```

# Gross rent as a percentage of hh income in last 12 months by age (B25072) (2005-2018)

```{r}
burdened_rent1 <- acs2009 %>%
  dplyr::select(CBSA, starts_with("B25072")) %>%
  transmute(CBSA = CBSA,
            LT20_15_24 = B25072e3/B25072e2,
            B20_24_15_24 = B25072e4/B25072e2,
            B25_29_15_24 = B25072e5/B25072e2,
            B30_34_15_24 = B25072e6/B25072e2,
            GT35_15_24 = B25072e7/B25072e2,
            LT20_25_34 = B25072e10/B25072e9,
            B20_24_25_34 = B25072e11/B25072e9,
            B25_29_25_34 = B25072e12/B25072e9,
            B30_34_25_34 = B25072e13/B25072e9,
            GT35_25_34 = B25072e14/B25072e9,
            LT20_35_64 = B25072e17/B25072e16,
            B20_24_35_64 = B25072e18/B25072e16,
            B25_29_35_64 = B25072e19/B25072e16,
            B30_34_35_64 = B25072e20/B25072e16,
            GT35_35_64 = B25072e21/B25072e16,
            LT20_65 = B25072e24/B25072e23,
            B20_24_65 = B25072e25/B25072e23,
            B25_29_65 = B25072e26/B25072e23,
            B30_35_65 = B25072e27/B25072e23,
            GT35_65 = B25072e28/B25072e23,
            LT20 = (!! census_sum("B25072e", 3, 24, 7))/B25072e1,
            B20_24 = (!! census_sum("B25072e", 4, 25, 7))/B25072e1,
            B25_29 = (!! census_sum("B25072e", 5, 26, 7))/B25072e1,
            B30_34 = (!! census_sum("B25072e", 6, 27, 7))/B25072e1,
            GT35 = (!! census_sum("B25072e", 7, 27, 7))/B25072e1) %>%
  arrange(desc(CBSA)) %>%
  mutate(Index = row_number())

burdened_rent_ranks <- as.data.frame(purrr::map(-burdened_rent1, rank))
```


